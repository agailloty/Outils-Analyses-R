---
title: "ACM"
author: "Axel-Cleris Gailloty"
date: "2023-03-30"
output: 
  md_document:
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = NA, fig.width = 8, 
                      fig.height = 6, warning = FALSE, message = FALSE)
options(digits = 4, scipen = 6)
```

```{r}
library(FactoMineR)
data("tea")
```

# Statistiques descriptives 

Nous pouvons dénombrer le nombre d'observations et de colonnes (variables) du jeu de données en utilisant la fonction `str()` dans R.

```{r}
str(tea)
```
Il y a 300 observations et 36 colonnes dans ce jeu de données. 

La grande partie des colonnes est reconnue par R comme des données variables contenant des modalités discrètes, c'est pour cela que le type des colonnes est Factor. 

Etant donnée que R a bien reconnu ces types de colonnes, il nous est possible de compter le nombre des modalités de chaque colonnes en utilisant soit la fonction `summary()`, soit la fonction `table()`. 

Par exemple si on veut savoir combien de perosnnes prennent leur thé avec du sucre, il suffit d'utiliser la fonction l'une des fonctions suivantes. 

```{r}
table(tea$sugar)
```

On voit que 155 personnes ont déclaré ne pas prendre leur thé avec du sucre, tandis que 145 ont déclaré en prendre avec du sucre. 

Le résultat est le même si on utilise la fonction `summary()`

```{r}
summary(tea$sugar)
```

# Tableaux croisés (tableau de contingence)

Il est aussi facile de produire des tableaux de contingence avec la fonction `table()`. Le tableau de contingence nous permet de croiser les modalités de deux colonnes afin de compter la fréquence conditionnelle. 

Par exemple parmi les personnes qui boivent leur thé avec du sucre, combien le boivent à la maison ?

```{r}
table(tea$sugar, tea$home)
```

Parmi les personnes qui boivent le thé chez eux (home), 153 boivent sans sucre. 


# Analyse des correspondances multiples 

```{r}
library(FactoMineR)
var_quanti_illustrative <- c("age")
idx_var_quanti_illustrative <- match(var_quanti_illustrative, colnames(tea))
acm <- MCA(tea, quanti.sup = idx_var_quanti_illustrative, graph = FALSE)
```

## Nombre de composantes à retenir

Contrairement à l'ACP, la règle de Kaiser ne s'applique pas pour une analyse des correspondances multiples. Le choix du nombre de composantes dépend du pourcentage de l'inertie expliquée qu'on estime satisfaisant. 


Le tableau suivant affiche le pourcentage de la variance expliquée par chaque axe. La dernière colonne du tableau affiche le pourcentage cumulé de variance expliquée par nombre de composantes. Si l'on retient 4 composantes dans l'analyse alors on arriverait à expliquer `r acm$eig[4, 3]` % de la variance totale.

```{r}
acm$eig
```

## Description de chaque composante

Pour la suite de l'étude nous faisons le choix de retenir 4 composantes. Nous allons expliquer une à une ce que chaque composante mesure. 
Avec FactoMiner nous pouvons utiliser la fonction `dimdesc` pour décrire chaque composante. 

La fonction dimdesc produit un nombre variable des tableaux de résultats selon qu'on a indiqué si des variables sont quantitatives illustratives ou non. 

## Composante 1

Dans notre cas, nous avons choisi la variable `age` comme variable quantitative illustrative, le premier tableau qui s'intitule **Link between the variable and the continuous variables (R-square)** affiche donc le coefficient de corrélation entre l'age et la composante 1. La valeur du coefficient de corrélation entre l'âge et la composante est : 0,151, cela signifie que l'âge est positivement corrélée avec la composante 1. Cette valeur peut nous suggérer qu'il y a un lien positif faible entre l'âge et la composante 1. Les personnes qui ont des coordonnées positives sur l'axe 1 ont tendance à être plus agés que les personnes ayant des coordonnées positives. 

Le deuxième tableau s'intitule **Link between the variable and the categorical variable (1-way anova)**, il s'agit d'une analyse de la variance (anova) à un facteur. Ce tableau contient deux colonnes : la colonne R2 qui désigne le coefficient de détermination. C'est le pouvoir explicatif de la variable sur la composante. On interprète le R2 comme le pouvoir explicatif de la variable sur la variance de la composante 1, autrement quel pourcentage de l'intertie totale de la composante 1 est capturée par la variable en question. Par exemple la variable `tearoom` explique 32% de la variance de la composante 1. 
La colonne `p.value` affiche la significativité de ce pouvoir explicatif. Si la valeur p est inférieure à 0.05 alors on rejette l'hypothèse selon laquelle la variable considérée n'a aucune influence sur la composante 1. 

Le dernier tableau s'intitule **Link between variable and the categories of the categorical variables**, il s'agit du sens de la relation entre les modalités des variables et la composante 1. 

Le deuxième tableau affiche le pouvoir explicatif de chaque variable sur la composante 1, le troisème tableau montre le sens des modalités de cette variable sur la composante 1. 



```{r}
# Décrire la composante 1
dimdesc(acm, axes = 1)
```

Au vu de ces résultats nous pouvons dire que la composante 1 représente les personnes qui consomment le thé dans un salon de thé (tearoom=tearoom), qui achètent leur thé dans un magasin de thé (where=chain store+tea shop), qui consomment du thé à un moment spécifique (tea.time=tea time), qui boivent du thé +2 fois par jour (frequency=+2/day) et sont pour la plupart des femmes (sex=F). 


## Composante 2 

Le lien entre l'âge et la composante 2 est plus accentué. En effet le coefficient de corrélation s'élève à 0.72, cela signifie donc que la composante 2 évolue fortement dans le même sens que l'âge. Les individus ayant des coordonnées positives sur cette composantes ont tendance à être plus agés. 

Cette intuition se vérifie dans le deuxième tableau où nous voyons que l'âge a un pouvoir explicatif (R2) de 63,3% sur la composante 2. Les autres variables qui ont un pouvoir explicatif sur cette composante sont la catégorie socio-professionnelle (SPC), le type de thé (Tea) qui indique le type de thé (noir, vert...), le lieu d'achat (where), le prix du thé (price), la façon de boire le thé (how) qui indique comment la personne achète son thé (en vrac, en sachet...). 


```{r}
dimdesc(acm, axes = 2)
```

La composante 2 semble mettre en avant le profil des consommateurs de thé agés (age_Q=+60), qui achètent du thé haut de gamme (price=p_upscale), dans un magasin de thé (where=tea shop) en vrac (how=unpackaged), et qui ne travaillent pas (SPC=non-worker), qui ont une préférence pour le thé noir (Tea=black).

## Représenter simultanément les deux composantes 

### Le graphique des variables

Le graphique suivant affiche un axe factoriel qui représente le profil des individus projetés sur les deux première composantes. LA composante 1 se lit de gauche à droite et la composante 2 de bas en haut. 

```{r message=FALSE, warning=FALSE}
library(factoextra)
fviz_mca_var(acm, axes = c(1,2), choixe = "var", repel = TRUE)
```

### Le graphique des modalités


```{r}
fviz_mca_var(acm, axes = c(1,2), choixe = "var.cat", repel = TRUE)
```


## Composante 3 

La composante 3 est faiblement négativement corrélée avec l'âge. Ce qui peut suggérer que cette composante représente un profil de consommateur assez jeune. 

Cette composante est expliquée à 30% par le format du thé que les consommateurs achètent (how), l'âge quant à lui explique 30% de cette composante, la catégorie socio-professionnelle (SPC) explique 27%, etc..

```{r}
dimdesc(acm, axes = 3)
```

Cette composante décrit les individus jeunes (age_Q=25-34), hommes (sex=M, feminine=Not.feminine) qui achètent leur thé dans un magasin (where=tea shop), qui ne boivent pas du thé pour l'effet minceur (slimming=No.slimming), qui achètent du thé haut de gamme (price=p_upscale), en vrac ou en sachet (how=tea bag+unpackaged). 

## Composante 4 

Sur cette composante, la variable age n'a aucune indicence significative (le tableau **Link between the variable and the continuous variables (R-square)** est absent.). 

Le fait de boire du thé au petit déjeuner ou non (breakfast) explique 28% de l'inertie de cette composante, la fréquence (frequency), la catégorie socio-professionnelle (SPC) expliquent environ 20% de la variance, etc..

```{r}
dimdesc(acm, axes = 4)
```
Cette composante représente un profil d'individus qui ne boivent pas du thé au petit déjeuner (breakfast=Not.breakfast), qui boivent du thé de manière sophistiquée (sophisticated=sophisticated), une à deux fois par semaine (frequency=1 to 2/week), qui achètent du thé dans un magasin de thé (where=tea shop) en vrac (how=unpackaged), qui accordent un côté féminin au fait de boire le thé (feminine=feminine)..

## Représentation simultanée des composantes 3 et 4 

### Le graphique des variables. 

```{r}
fviz_mca_var(acm, axes = c(3,4) , choice = "var", repel = TRUE)
```

### Le graphique des modalités 

```{r}
fviz_mca_var(acm, axes = c(3,4), choice = "var.cat", repel = TRUE)
```

# Classification ascendante hiérarchique (CAH)

Nous pouvons réaliser une classification en laissant FactoMineR décider du nombre optimal de clusters. 

```{r message=FALSE, warning=FALSE}
classif <- HCPC(acm, nb.clust = -1, graph = FALSE)
```

Nous pouvons utiliser la fonction `summary()` pour afficher le nombre de clusters ainsi que le nombre d'individus dans chaque cluster. 

```{r}
summary(classif$data.clust$clust)
```

FactoMineR a déterminer que 4 est le nombre optimal de clusters. Les clusters 1 et 4 regroupent le plus d'individus. 

## Description de chaque cluster

### Cluster 1

Le tableau suivant nous permet de dresser le profil des individus qui sont caractérisés dans le cluster 1.
Il contient 5 colonnes.  

Les colonnes Cla/Mod et Mod/Cla représentent des probabilités conditionnelles. 

Pour avoir une compréhension plus nette de ces probabilités, décomposons les modalités de la variable `where`. 

```{r}
table(classif$data.clust$where)
```

N = 192 + 78 + 30 = 300

Nous voyons que P(where=chain store) = 192 / N => 192/300 = 64%
C'est ce qu'indique la colonne Global. 

Pour les probabilités conditionnelles, décomposons la variable `where` par cluster dans un tableau de contingence. 

```{r}
table(classif$data.clust$clust, classif$data.clust$where)
```
Les lignes de ce tableau sont les clusters, les colonnes sont les modalités de la variable `where`. 

Nous savons que P(where=chain store) = 64%

Nous voulons maintenant savoir la probabilité de P(clust=1 / where=chain store), parmi les individus qui ont répondu `where=chain store` combien se trouvent dans le cluster 1? 

Cla/Mod = 123 / (123 + 9 + 31 + 29) => 123/192 => 64,06%. 

Nous voulons maintenant savoir la probabilité d'être dans le cluster 1 et d'avoir répondu `where=chain store`. P(where=chain store / clust=1). 


Mod/Cla = 123 / 123+8+0 => 123/131 => 93,89%.


La colonne v.test nous indique le signe des modalités qui influencent positivement ou négativement les individus de ce cluster. Si le v.test est positif alors les individus du cluster sont surreprésentés dans la modalité considérée. 

La colonne p.value indique la significativité de cette modalité pour le cluster 1. Si p.value < 0.05 alors l'hypothèse selon laquelle la modalité `where=chain store` ne caractérise pas le cluster 1 est rejetée, autrement dit cette modalité caractérise bien les individus du cluster 1. 

L'interprétation de tout le tableau suit la logique que je viens de décrire plus haut. 

**En pratique dans ce tableau, c'est la colonne Mod/Cla qui a le plus d'intérêt car il indique la sous-représentation ou la sur-représentation des individus du cluster dans une modalité.**


```{r}
classif$desc.var$category[1]
```


## Représentation graphique des clusters 

```{r fig.width=10}
fviz_cluster(classif, axes = c(1,2))
```

```{r fig.width=10}
fviz_cluster(classif, axes = c(3,4))
```

## Les individus parangon et spécifiques

Comme dans l'ACP nous pouvons afficher les individus parangon et spécifiques de chaque cluster. Pour rappel, les individus parangons sont les individus les plus au centre de chaque cluster, et les individus spécifiques sont les individus le splus éloignés du centre de chaque cluster. 

### Individus parangons

```{r}
classif$desc.ind$para
```

## Afficher les caractéristiques des individus parangons du cluster 1 

Les individus du cluster 1 sont caractérisés positivement par les variables *"where", "how", "tearoom", "age", "price", "SPC", "sugar"*, nous pouvons afficher les réponses des individus parangons pour ces variables considérées.

```{r}
tea[c(116, 214, 164, 5, 121), c("where", "how", "tearoom", "age", "price", "SPC", "sugar")]
```

### Individus spécifiques


```{r}
classif$desc.ind$dist
```

```{r}
tea[c(1, 6, 219, 200, 76), c("where", "how", "tearoom", "age", "price", "SPC", "sugar")]
```

Ces individus ont des valeurs identiques pour *"where", "how", "tearoom"*